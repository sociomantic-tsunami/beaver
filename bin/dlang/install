#!/bin/sh
# Copyright sociomantic labs GmbH 2017.
# Distributed under the Boost Software License, Version 1.0.
# (See accompanying file LICENSE.txt or copy at
# http://www.boost.org/LICENSE_1_0.txt)
#
# Build a docker image for D projects
set -eu

# Package name deduced based on supplied DMD version
case "$DMD" in
    dmd*   ) PKG= ;;
    1.*    ) PKG="dmd1=$DMD-$DIST" ;;
    2.*.s* ) PKG="dmd-transitional=$DMD-$DIST" ;;
    2.*    ) if [ $(echo $DMD | cut -d. -f2) -ge 077 ]; then
                PKG="dmd-compiler=$DMD dmd-tools=$DMD libphobos2-dev=$DMD"
             else
                PKG="dmd-bin=$DMD libphobos2-dev=$DMD"
             fi ;;
    *      ) echo "Unknown \$DMD ($DMD)" >&2; exit 1 ;;
esac

beaver install -I 'ARG DMD_PKG' -I 'ENV DMD_PKG=$DMD_PKG' \
    -I 'RUN apt update && apt -y install --allow-downgrades $DMD_PKG' "$@" \
    -- --build-arg "DMD_PKG=$PKG"
