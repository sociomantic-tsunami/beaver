#!/bin/bash
# Copyright sociomantic labs GmbH 2017.
# Distributed under the Boost Software License, Version 1.0.
# (See accompanying file LICENSE.txt or copy at
# http://www.boost.org/LICENSE_1_0.txt)
set -eu

beaver_context_dir="."
declare -a dockerfile_commands

while [ "$#" -ne 0 ] && [ "$1" != "--" ]
do
    case "$1" in
        -t)
        export BEAVER_DOCKER_IMG="$2"
        shift
        shift
        ;;
        -d)
        beaver_context_dir="$2"
        shift
        shift
        ;;
        -I)
        dockerfile_commands+=("-I")
        dockerfile_commands+=("$2")
        shift
        shift
        ;;
        *)
        shift
        ;;
    esac
done

if [ "$#" -ne 0 ] && [ "$1" = "--" ]; then shift; fi

generate_and_build()
{
    if test -r "Dockerfile${DIST:+.$DIST}"
    then
        # Build the docker image using .$DIST as suffix if present
        beaver docker build -f "Dockerfile${DIST:+.$DIST}" "$@" .
    else
        # Build the docker image based on a beaver.Dockerfile base file
        set -x
        beaver docker gen-dockerfile \
            -i beaver.Dockerfile \
            -o beaver.Dockerfile.generated \
            "${dockerfile_commands[@]-}"
        beaver docker build -f beaver.Dockerfile.generated "$@" .
    fi
}

(cd $beaver_context_dir && generate_and_build "$@")
